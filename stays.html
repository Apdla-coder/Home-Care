<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      body {
        background-color: #f5f5f5;
        font-family: "Tahoma", sans-serif;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background-color: white;
      }
      .btn {
        font-size: 15px;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .modal-content,
        .modal-content * {
          visibility: visible !important;
        }
        .modal {
          position: absolute;
          top: 0;
          right: 0;
          width: 100%;
          display: block !important;
        }
      }
    </style>
  </head>
  <body class="p-3">
    <a
      href="control.html"
      class="navbar-brand d-inline-block mb-3"
      style="
        color: blue;
        padding: 12px 20px;
        background-color: white;
        border-radius: 50px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        text-decoration: none;
      "
    >
      â† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    </a>

    <div class="container">
      <h2 class="text-center mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª</h2>

      <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ -->
      <div class="card p-4 mb-4">
        <h5 class="mb-3">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
        <form id="patientForm">
          <div class="row g-3">
            <div class="col-md-2">
              <input
                required
                class="form-control"
                id="id"
                placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"
              />
            </div>
            <div class="col-md-2">
              <input
                required
                class="form-control"
                id="patientName"
                placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"
              />
            </div>
            <div class="col-md-2">
              <input class="form-control" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
            </div>
            <div class="col-md-2">
              <input
                type="number"
                class="form-control"
                id="age"
                placeholder="Ø§Ù„Ø³Ù†"
              />
            </div>
            <div class="col-md-4">
              <input
                class="form-control"
                id="condition"
                placeholder="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©"
              />
            </div>
          </div>
          <button class="btn btn-primary mt-3" type="submit">
            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶
          </button>
        </form>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h5>
          <button class="btn btn-outline-success" onclick="exportToExcel()">
            â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel
          </button>
        </div>
        <table class="table table-bordered table-striped" id="patientsTable">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ø±Ù‚Ù…</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th>Ø§Ù„Ø³Ù†</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª -->
    <div class="modal fade" id="staysModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶ <span id="modalPatientName"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¥Ù‚Ø§Ù…Ø© -->
            <form id="stayForm" class="row g-3 mb-4">
              <input type="hidden" id="stayPatientId" />
              <input type="hidden" id="stayIndex" />
              <div class="col-md-2">
                <input
                  required
                  class="form-control"
                  id="nurse"
                  placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ø±Ø¶"
                />
              </div>
              <div class="col-md-2">
                <input required type="date" class="form-control" id="date" />
              </div>
              <div class="col-md-2">
                <input required type="date" class="form-control" id="endDate" />
              </div>
              <div class="col-md-2">
                <input
                  required
                  type="number"
                  class="form-control"
                  id="hours"
                  placeholder="Ø§Ù„Ø³Ø§Ø¹Ø§Øª"
                />
              </div>
              <div class="col-md-2">
                <input
                  required
                  type="number"
                  class="form-control"
                  id="rate"
                  placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©"
                />
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" type="submit">
                  ğŸ’¾ Ø­ÙØ¸
                </button>
              </div>
            </form>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª -->
            <div id="printArea">
              <table class="table table-bordered table-hover" id="staysTable">
                <thead class="table-light">
                  <tr>
                    <th>Ù…Ù†</th>
                    <th>Ø¥Ù„Ù‰</th>
                    <th>Ø§Ù„Ù…Ù…Ø±Ø¶</th>
                    <th>Ø§Ù„Ù…Ø¯Ø© (Ø³Ø§Ø¹Ø§Øª)</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button onclick="window.print()" class="btn btn-outline-dark">
              ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const patients = JSON.parse(localStorage.getItem("patients")) || [];
      const patientForm = document.getElementById("patientForm");
      const stayForm = document.getElementById("stayForm");
      const patientsTable = document.querySelector("#patientsTable tbody");
      const staysTable = document.querySelector("#staysTable tbody");
      const staysModal = new bootstrap.Modal(
        document.getElementById("staysModal")
      );

      function renderPatients() {
        patientsTable.innerHTML = "";
        patients.forEach((p, i) => {
          const row = `
            <tr>
              <td>${p.id}</td>
              <td>${p.name}</td>
              <td>${p.address}</td>
              <td>${p.age}</td>
              <td>${p.condition}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="openStays('${p.id}')">Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient(${i})">ğŸ—‘ï¸</button>
              </td>
            </tr>`;
          patientsTable.insertAdjacentHTML("beforeend", row);
        });
      }

      function deletePatient(index) {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶ØŸ")) {
          patients.splice(index, 1);
          localStorage.setItem("patients", JSON.stringify(patients));
          renderPatients();
        }
      }

      patientForm.onsubmit = (e) => {
        e.preventDefault();
        const newPatient = {
          id: id.value,
          name: patientName.value,
          address: address.value,
          age: age.value,
          condition: condition.value,
          stays: [],
        };
        patients.push(newPatient);
        localStorage.setItem("patients", JSON.stringify(patients));
        renderPatients();
        patientForm.reset();
      };

      function openStays(patientId) {
        const patient = patients.find((p) => p.id === patientId);
        if (!patient) return;

        document.getElementById("modalPatientName").textContent = patient.name;
        document.getElementById("stayPatientId").value = patient.id;
        staysTable.innerHTML = "";

        if (!patient.stays || patient.stays.length === 0) {
          staysTable.innerHTML = `<tr><td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù‚Ø§Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
        } else {
          patient.stays.forEach((stay, index) => {
            const total = stay.hours * stay.rate;
            const row = `
              <tr>
                <td>${stay.date}</td>
                <td>${stay.endDate}</td>
                <td>${stay.nurse}</td>
                <td>${stay.hours} Ø³Ø§Ø¹Ø©</td>
                <td>${stay.rate} Ø¬Ù†ÙŠÙ‡</td>
                <td><strong class="text-success">${total} Ø¬Ù†ÙŠÙ‡</strong></td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="editStay('${patient.id}', ${index})">âœï¸</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteStay('${patient.id}', ${index})">ğŸ—‘ï¸</button>
                </td>
              </tr>`;
            staysTable.insertAdjacentHTML("beforeend", row);
          });
        }

        stayForm.reset();
        document.getElementById("stayIndex").value = "";
        staysModal.show();
      }

      stayForm.onsubmit = (e) => {
        e.preventDefault();
        const id = stayPatientId.value;
        const patient = patients.find((p) => p.id === id);
        const index = stayIndex.value;
        const newStay = {
          nurse: nurse.value,
          date: date.value,
          endDate: endDate.value,
          hours: Number(hours.value),
          rate: Number(rate.value),
        };

        if (!patient.stays) patient.stays = [];
        if (index === "") {
          patient.stays.push(newStay);
        } else {
          patient.stays[Number(index)] = newStay;
        }

        localStorage.setItem("patients", JSON.stringify(patients));
        openStays(id);
      };

      function editStay(patientId, index) {
        const patient = patients.find((p) => p.id === patientId);
        const stay = patient.stays[index];
        stayIndex.value = index;
        stayPatientId.value = patientId;
        nurse.value = stay.nurse;
        date.value = stay.date;
        endDate.value = stay.endDate;
        hours.value = stay.hours;
        rate.value = stay.rate;
      }

      function deleteStay(patientId, index) {
        const patient = patients.find((p) => p.id === patientId);
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŸ")) {
          patient.stays.splice(index, 1);
          localStorage.setItem("patients", JSON.stringify(patients));
          openStays(patientId);
        }
      }

      function exportToExcel() {
        const data = [];
        patients.forEach((p) => {
          if (!p.stays || p.stays.length === 0) {
            data.push({
              "Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶": p.id,
              "Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶": p.name,
              Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: p.address,
              Ø§Ù„Ø³Ù†: p.age,
              Ø§Ù„Ø­Ø§Ù„Ø©: p.condition,
              "Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ø±Ø¶": "-",
              "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©": "-",
              "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "-",
              Ø§Ù„Ù…Ø¯Ø©: "-",
              "Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©": "-",
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "-",
            });
          } else {
            p.stays.forEach((s) => {
              data.push({
                "Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶": p.id,
                "Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶": p.name,
                Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: p.address,
                Ø§Ù„Ø³Ù†: p.age,
                Ø§Ù„Ø­Ø§Ù„Ø©: p.condition,
                "Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ø±Ø¶": s.nurse,
                "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©": s.date,
                "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": s.endDate,
                Ø§Ù„Ù…Ø¯Ø©: s.hours,
                "Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©": s.rate,
                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: s.hours * s.rate,
              });
            });
          }
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª");
        XLSX.writeFile(wb, "Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª_ÙˆØ§Ù„Ù…Ø±Ø¶Ù‰.xlsx");
      }

      renderPatients();
    </script>
  </body>
</html>
